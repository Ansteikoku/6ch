<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ï¼–ã¡ã‚ƒã‚“ã­ã‚‹ - ã‚¹ãƒ¬ãƒƒãƒ‰è©³ç´°</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    #thread-title { font-weight: bold; font-size: 1.5em; margin-bottom: 10px; }
    #thread-body { margin-bottom: 20px; }
    #thread-image { max-width: 300px; margin-bottom: 20px; }
    #comments { background: #fff; padding: 10px; border: 1px solid #ccc; max-height: 400px; overflow-y: auto; }
    .comment { border-bottom: 1px solid #ddd; padding: 5px 0; }
    .comment:last-child { border-bottom: none; }
    #comment-form textarea { width: 100%; height: 80px; }
  </style>
</head>
<body>
  <h1 id="thread-title">èª­ã¿è¾¼ã¿ä¸­...</h1>
  <div id="thread-body"></div>
  <img id="thread-image" src="" alt="" style="display:none;" />

  <h2>ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§</h2>
  <button onclick="loadComments()">ğŸ”„ ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°</button>
  <div id="comments">ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

  <h3>ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿</h3>
  <form id="comment-form">
    <input type="text" id="comment-name" placeholder="åå‰ï¼ˆçœç•¥å¯ï¼‰" /><br />
    <textarea id="comment-body" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡" required></textarea><br />
    <button type="submit">ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿</button>
  </form>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://npyamxaqnmyosgpduuxl.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5weWFteGFxbm15b3NncGR1dXhsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMjAwMzUsImV4cCI6MjA2Nzc5NjAzNX0.ViqzFOpRJiOJQUdBDCV0ISloACe6b9Oa1pE_OpeefeU"
    );

    const urlParams = new URLSearchParams(window.location.search);
    const threadId = urlParams.get('id');

    const threadTitleEl = document.getElementById('thread-title');
    const threadBodyEl = document.getElementById('thread-body');
    const threadImageEl = document.getElementById('thread-image');
    const commentsEl = document.getElementById('comments');
    const commentForm = document.getElementById('comment-form');

    if (!threadId) {
      threadTitleEl.textContent = 'ã‚¹ãƒ¬ãƒƒãƒ‰IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
      throw new Error('No thread id');
    }

    async function loadThread() {
      const { data, error } = await supabase
        .from('threads')
        .select('*')
        .eq('id', threadId)
        .single();

      if (error || !data) {
        threadTitleEl.textContent = 'ã‚¹ãƒ¬ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
        console.error(error);
        return;
      }

      threadTitleEl.textContent = data.title;
      threadBodyEl.textContent = data.body;

      if (data.image_url) {
        threadImageEl.src = data.image_url;
        threadImageEl.style.display = 'block';
      }
    }

    async function loadComments() {
      const { data, error } = await supabase
        .from('comments')
        .select('*')
        .eq('thread_id', threadId)
        .order('created_at', { ascending: true });

      if (error) {
        commentsEl.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
        console.error(error);
        return;
      }

      if (!data || data.length === 0) {
        commentsEl.textContent = 'ã‚³ãƒ¡ãƒ³ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“';
        return;
      }

      commentsEl.innerHTML = '';
      data.forEach(comment => {
        const div = document.createElement('div');
        div.className = 'comment';
        const name = comment.name || 'åç„¡ã—ã•ã‚“';
        const time = new Date(comment.created_at).toLocaleString();
        div.innerHTML = `
          <strong>${name}</strong> <small>${time}</small><br>
          <pre style="white-space: pre-wrap;">${escapeHtml(comment.body)}</pre>
        `;
        commentsEl.appendChild(div);
      });
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('comment-name').value || 'åç„¡ã—ã•ã‚“';
      const body = document.getElementById('comment-body').value.trim();

      if (!body) {
        alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const { error } = await supabase.from('comments').insert([{
        thread_id: threadId,
        name,
        body
      }]);

      if (error) {
        alert('ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        console.error(error);
        return;
      }

      commentForm.reset();
      await loadComments();
    });

    loadThread();
    loadComments();
  </script>
</body>
</html>
